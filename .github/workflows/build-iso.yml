---
  name: build-iso
  on: 
    workflow_call:

  jobs:
    
    build_iso:
      name: Build Installer ISO
      runs-on: ubuntu-latest
      outputs:
        iso_name: ${{ steps.build_iso.outputs.iso_name }}
        checksum: ${{ steps.build_iso.outputs.iso_name }}-CHECKSUM
  
      env:
        ARCH: x86_64
        IMAGE_NAME: hyprland-atomic
        IMAGE_REPO: ghcr.io/cjuniorfox
        IMAGE_TAG: latest
        VARIANT: base-main
        VERSION: 40

      steps:
        - name: Checkout Push to Registry action
          uses: actions/checkout@v3 # Updated to latest stable version
  
        - name: Build ISO
          uses: jasonn3/build-container-installer@v1.2.2
          id: build_iso
          with:
            arch: ${{ env.ARCH }}
            image_name: ${{ env.IMAGE_NAME }}
            image_repo: ${{ env.IMAGE_REPO }}
            image_tag: ${{ env.IMAGE_TAG }}
            version: ${{ env.VERSION }}
            variant: ${{ env.VARIANT }}
            iso_name: ${{ env.IMAGE_NAME }}-${{ env.ARCH }}-${{ env.VERSION }}-${{ env.IMAGE_TAG }}.iso
            secure_boot_key_url: 'https://github.com/ublue-os/akmods/raw/main/certs/public_key.der'
            enrollment_password: 'ublue-os'
            enable_cache_dnf: "false"
            enable_cache_skopeo: "false"
            flatpak_remote_refs: "com.github.tchx84.Flatseal org.gnome.Calculator org.gnome.Evince org.gnome.FileRoller org.gnome.FontManager org.gnome.Loupe org.gnome.TextEditor org.mozilla.firefox org.freedesktop.Platform.openh264/x86_64/2.3.1 org.freedesktop.Platform.ffmpeg-full/x86_64/22.08"
  
        - name: Move ISOs to Upload Directory
          id: upload_directory
          shell: bash
          run: |
            ISO_UPLOAD_DIR=${{ github.workspace }}/upload
            mkdir ${ISO_UPLOAD_DIR}
            mv ${{ steps.build_iso.outputs.iso_path }}/${{ steps.build_iso.outputs.iso_name }} ${ISO_UPLOAD_DIR}
            mv ${{ steps.build_iso.outputs.iso_path }}/${{ steps.build_iso.outputs.iso_name }}-CHECKSUM ${ISO_UPLOAD_DIR}
            echo "iso-upload-dir=${ISO_UPLOAD_DIR}" >> $GITHUB_OUTPUT
            
        - name: Upload ISO as artifact
          id: upload
          uses: actions/upload-artifact@v4
          with:
            name: ${{ steps.build_iso.outputs.iso_name }}
            path: ${{ steps.upload_directory.outputs.iso-upload-dir }}
            if-no-files-found: error
            retention-days: 1 # Updated to a valid retention period
  