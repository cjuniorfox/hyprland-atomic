---
name: "Image and ISO"
on:
  workflow_call:
    secrets:
      AWS_ACCESS_KEY_ID: 
        required: true
      AWS_SECRET_ACCESS_KEY: 
        required: true
        
      WG_PRIVATE:
        required: true
      WG_IP:
        required: true
      WG_ENDPOINT_PUBKEY:
        required: true
      WG_ALLOWED_IPS:
        required: true
      WG_ENDPOINT:
        required: true
      ARTIFACT_HOST:
        required: true
      PRIVATE_SSH_KEY:
        required: true
      SSH_USER:
        required: true
      
    inputs:
      hyprland_build:
        default: "fedora"
        type: string
      version:
        type: number
        required: true
      virtualization:
        type: string
        default: "no"

jobs:
  set_image_name:
    name: "Set image name"
    uses: "./.github/workflows/set-image-name.yml"
    with:
      hyprland_build: ${{ inputs.hyprland_build }}
      version: ${{ inputs.version }}

  build_iso:
    name: "Build ISO"
    uses: ./.github/workflows/installer-iso.yml
    needs:
      - set_image_name
    with:
      image_name: "${{ needs.set_image_name.outputs.image_name }}"
      image_repo: "ghcr.io/cjuniorfox"
      image_tag: ${{ inputs.version }}
      version: ${{ inputs.version }}
  upload_iso_to_server:
    if: false
    name: "Upload ISO to server"
    uses: ./.github/workflows/upload-iso-to-server.yml
    needs: build_iso
    secrets:
      WG_PRIVATE: ${{ secrets.WG_PRIVATE }}
      WG_IP: ${{ secrets.WG_IP }}
      WG_ENDPOINT_PUBKEY: ${{ secrets.WG_ENDPOINT_PUBKEY }}
      WG_ALLOWED_IPS: ${{ secrets.WG_ALLOWED_IPS }}
      WG_ENDPOINT: ${{ secrets.WG_ENDPOINT }}
      ARTIFACT_HOST: ${{ secrets.ARTIFACT_HOST }}
      PRIVATE_SSH_KEY: ${{ secrets.PRIVATE_SSH_KEY }}
      SSH_USER: ${{ secrets.SSH_USER }}

  upload_iso_to_s3:
    name: "Upload ISO to S3"
    uses: ./.github/workflows/upload-iso-to-s3.yml
    needs: build_iso
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    with:
      s3_bucket: juniorfox-net-isos
      aws_region: sa-east-1
      iso_name: ${{ needs.build_iso.outputs.iso_name }}
      checksum: ${{ needs.build_iso.outputs.checksum }}